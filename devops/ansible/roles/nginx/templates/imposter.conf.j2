upstream {{ app_name }} {
  server unix:{{ puma_socket_dir }};
}

server {
  listen 80;
  listen 443 default ssl;

  #ssl on;
  ssl_ciphers ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:RSA+3DES:!ADH:!AECDH:!MD5;
  ssl_prefer_server_ciphers on;
  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_certificate {{ ssl_crt }};
  ssl_certificate_key {{ ssl_private_key }};

  server_name {{ nginx_server_name_list | join(" ") }};

  root {{ remote_app_root_dir }}/public;

  location / {
    proxy_pass http://{{ app_name }};
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ~* ^/assets/ {
    # Per RFC2616 - 1 year max expiry
    expires 1y;
    add_header Cache-Control public;
    add_header Last-Modified "";
    add_header Etag "";
    break;
  }

  error_page 502 /502.html;

  location = /502.html {
    root {{ remote_app_root_dir }}/public;
  }
}
